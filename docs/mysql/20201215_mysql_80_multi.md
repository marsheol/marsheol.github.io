# MySQL 8.0 多实例安装笔记

## 1 概要

### 1.1 相关配置

```
服务器A：172.28.222.150 --- Master
虚拟IP（VIP）：
MySQL版本：8.0.15（mysql-8.0.15-linux-glibc2.12-x86_64.tar.xz）
操作系统：Red Hat Enterprise Linux Server release 6.5 (Santiago)  x86_64
```

### 1.2 安装目的

在 A 服务器上安装 MySQL 双实例并用 mysqld_multi 管理

## 2 安装 MySQL 双实例

### 2.1 准备免编译二进制包

```
mysql-8.0.15-linux-glibc2.12-x86_64.tar.xz
http://dev.mysql.com/downloads/mysql/
```

### 2.2 解压和迁移

```
# xz -dk mysql-8.0.15-linux-glibc2.12-x86_64.tar.xz
# tar xvf mysql-8.0.15-linux-glibc2.12-x86_64.tar
# mv mysql-8.0.15-linux-glibc2.12-x86_64/ /usr/local/mysql/
```

### 2.3 关闭 iptables 和 SELINUX

```
临时关闭：service iptables stop
永久关闭：chkconfig iptables off
# vim /etc/sysconfig/selinux
将SELINUX修改为DISABLED，即SELINUX=DISABLED
```

### 2.4 创建 MySQL 组和用户

```
# groupadd mysql
# useradd -g mysql -s /sbin/nologin mysql
```

### 2.5 创建相关目录

```
# mkdir -p /data/mysql/{6011,6012} --- 以实际端口号命名
# mkdir /data/mysql/6011/{data,tmp}
# mkdir /data/mysql/6012/{data,tmp}
```

### 2.6 更改目录权限

```
# chown -R mysql:mysql /data/mysql/
# chown -R mysql:mysql /usr/local/mysql/
```

### 2.7 添加环境变量

```
# echo "export PATH=/usr/local/mysql/bin:$PATH" >>/etc/profile
# source /etc/profile
```

### 2.8 编辑 my.cnf

```
# vim /etc/my.cnf

##################################################
##################### GLOBAL #####################
##################################################
[client]
port = 3306
socket = /tmp/mysql.sock
[mysqld_multi]
mysqld = /usr/local/mysql/bin/mysqld_safe
mysqladmin = /usr/local/mysql/bin/mysqladmin
log = /data/mysql/mysqld_multi.log

[mysqld]
user = mysql
basedir = /usr/local/mysql
skip-external-locking
skip-name-resolve
default-storage-engine = innodb
character_set_server = utf8mb4
explicit_defaults_for_timestamp = 1
wait_timeout = 3600
interactive_timeout = 3600
lock_wait_timeout = 3600
event_scheduler = 1

#binlog
max_binlog_size = 1G
binlog_cache_size = 2M
expire_logs_days = 5
sync_binlog = 1000
#replication
slave_net_timeout = 10
skip-slave-start
max_relay_log_size = 1G
log_slave_updates = 1
relay_log_purge = 1
relay_log_recovery = 1

#slow log
slow_query_log = 1
long_query_time = 2

# log_queries_not_using_indexes = 1

#per_thread_buffer
max_connections = 2048
max_connect_errors=100000
key_buffer_size = 64M
max_allowed_packet = 64M
table_open_cache = 2048
table_definition_cache = 2048
sort_buffer_size = 16M
read_buffer_size = 16M
read_rnd_buffer_size = 16M
join_buffer_size = 16M
tmp_table_size = 64M
max_heap_table_size = 64M
myisam_sort_buffer_size = 64M
thread_cache_size = 32

# query_cache_size = 16M # 8.0 退环境

#InnoDB
innodb_data_file_path = ibdata1:1G:autoextend
innodb_open_files = 2048
innodb_log_file_size = 1024M
innodb_log_buffer_size = 64M
innodb_log_files_in_group = 2
innodb_flush_log_at_trx_commit = 2
innodb_file_per_table = 1
innodb_flush_method = O_DIRECT
innodb_io_capacity = 1000
innodb_print_all_deadlocks = 1

# innodb_file_format = Barracuda # 8.0 退环境

# innodb_file_format_max = Barracuda # 8.0 退环境

innodb_strict_mode = 1
performance_schema_max_table_instances=400
innodb_undo_log_truncate = 1

# innodb_undo_tablespaces = 4 # 8.0 退环境，InnoDB always creates 2 undo tablespaces to start with.

innodb_max_undo_log_size = 500M
innodb_purge_rseg_truncate_frequency = 128
innodb_online_alter_log_max_size = 500M

[mysqldump]
quick
max_allowed_packet = 128M

[mysqld_safe]
user = mysql
open_files_limit = 28192

[mysql]
no-auto-rehash

[myisamchk]
key_buffer_size = 256M
sort_buffer_size = 256M
read_buffer = 2M
write_buffer = 2M

[mysqlhotcopy]
interactive-timeout

##################################################
##################### LOCAL ######################
##################################################
[mysqld6011]
mysqld = mysqld
mysqladmin = mysqladmin
datadir = /data/mysql/6011/data
tmpdir = /data/mysql/6011/tmp
port = 6011
server_id = 22215001
socket = /tmp/mysql_6011.sock
log-output = file
slow_query_log_file = /data/mysql/6011/slow.log
log-error = /data/mysql/6011/error.log
binlog_format = row
log-bin = /data/mysql/6011/mysql6011_bin
relay_log = /data/mysql/6011/relay6011-bin
relay_log_info_file = relay-log6011.info
innodb_thread_concurrency = 2
innodb_read_io_threads = 1
innodb_write_io_threads = 1
innodb_buffer_pool_size = 256M

[mysqld6012]
mysqld = mysqld
mysqladmin = mysqladmin
datadir = /data/mysql/6012/data
tmpdir = /data/mysql/6012/tmp
port = 6012
server_id = 22215002
socket = /tmp/mysql_6012.sock
log-output = file
slow_query_log_file = /data/mysql/6012/slow.log
log-error = /data/mysql/6012/error.log
binlog_format = row
log-bin = /data/mysql/6012/mysql6012_bin
relay_log = /data/mysql/6012/relay6012-bin
relay_log_info_file = relay-log6012.info
innodb_thread_concurrency = 2
innodb_read_io_threads = 1
innodb_write_io_threads = 1
innodb_buffer_pool_size = 256M
```

### 2.9 初始化数据库(no password)

```
# /usr/local/mysql/bin/mysqld --initialize-insecure --user=mysql --basedir=/usr/local/mysql/ --datadir=/data/mysql/6011/data
# /usr/local/mysql/bin/mysqld --initialize-insecure --user=mysql --basedir=/usr/local/mysql/ --datadir=/data/mysql/6012/data
```

### 2.10 设置启动文件

```
# cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysql
```

### 2.11 修改 root 密码并配置 mysqladmin 加密文件

```
# mysql -S /tmp/mysql_6011.sock -p
> set password for root@'localhost'=password('mars123'); --- 参看密码标准
> flush privileges;

# mysql_config_editor set --login-path=client --host=localhost --user=root --password
```

### 2.12 测试多实例管理

```
启动全部实例：/usr/local/mysql/bin/mysqld_multi start
查看全部实例状态：/usr/local/mysql/bin/mysqld_multi report
启动单个实例：/usr/local/mysql/bin/mysqld_multi start 6011
停止单个实例：/usr/local/mysql/bin/mysqld_multi stop 6011
查看单个实例状态：/usr/local/mysql/bin/mysqld_multi report 6011
查看启动进程：netstat -nltp | grep mysql
```

> 注：如遇到 mysql_multi 不能停止 MySQL 服务
> 报错现象：
> mysqladmin: connect to server at 'localhost' failed
> error: 'Access denied for user 'root'@'localhost' (using password: YES)'

> 解决方法：
> 修改 mysqld_multi 的如下行
> my $com= join ' ', 'my_print_defaults', @defaults_options, $group;
> 修改为
> my $com= join ' ', 'my_print_defaults -s', @defaults_options, $group;
